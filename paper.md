---
title: 'patRoon 2.0: Improved non-target analysis workflows including automated transformation product screening'
tags:
    - R
    - non-target screening
    - transformation products
    - high resolution mass spectrometry
authors:
    - name: Rick Helmus^[corresponding author, r.helmus\@uva.nl]
      orcid: 0000-0001-9401-3133
      affiliation: 1
    - name: Bas van de Velde
      orcid: 0000-0003-1292-3251
      affiliation: "1, 2, 3"
    - name: Andrea M. Brunner
      orcid: 0000-0002-2801-1751
      affiliation: "2, 4"
    - name: Thomas L. ter Laak
      orcid: 0000-0002-6182-6004
      affiliation: "1, 2"
    - name: Annemarie P. van Wezel
      orcid: 0000-0002-6875-957X
      affiliation: 1
    - name: Emma L. Schymanski
      orcid: 0000-0001-6868-8145
      affiliation: 5
affiliations:
    - name: Institute for Biodiversity and Ecosystem Dynamics (IBED), University of Amsterdam, P.O. Box 94240, 1090 GE Amsterdam, The Netherlands.
      index: 1
    - name: KWR Water Research Institute, Chemical Water Quality and Health, P.O. Box 1072, 3430 BB Nieuwegein, The Netherlands. 
      index: 2
    - name: Division of BioAnalytical Chemistry, Amsterdam Institute of Molecular and Life Sciences (AIMMS), Vrije Universiteit Amsterdam, 1081 HV Amsterdam, The Netherlands.
      index: 3
    - name: TNO, Environmental Modelling, Sensing and Analysis (EMSA), Princetonlaan 8, 3584 CB, Utrecht, The Netherlands.
      index: 4
    - name: Luxembourg Centre for Systems Biomedicine (LCSB), University of Luxembourg, L-4367 Belvaux, Luxembourg.
      index: 5
date: 3 December 2021
bibliography: paper.bib
---

# Summary

Non-target analysis (NTA) via chromatography coupled to high resolution mass spectrometry (HRMS) is used to monitor and
identify organic chemicals in the environment. Biotic and abiotic processes can transform original chemicals (parents)
into _transformation products_ (TPs). These TPs can be of equal or more concern than their parent compounds and are
therefore critical to monitor and identify in the environment [@Farre2008;@Escher2011], often with NTA. 
Given the amount of data generated by NTA, advanced automated data processing workflows are essential. The open-source,
`R`-based [@R] platform `patRoon` [@Helmus2021] offers automated, straightforward, flexible and comprehensive NTA
workflows.

This article describes improvements introduced in `patRoon 2.0`, including extensive TP screening and simultaneous
processing of positive and negative HRMS data. The updated documentation and code are available via
<https://rickhelmus.github.io/patRoon> and archived in @patRoon20Zen.

# Statement of need

The identification of chemicals in NTA still remains a grand challenge [@Vermeulen2020]; only a small percentage of
detected masses can be confidently annotated with spectral libraries [@daSilva2015]. The unidentified "dark matter" is
partly due to TPs, motivating the need for TP screening workflows. Reported approaches include screening of
known/predicted TPs, parent/TP classification techniques, isotope labeling experiments and identifying expected
(dis)similarities in MS data (shown in \autoref{tab:TPApproaches}; also reviewed in @Li2021). However, these approaches
are typically designed for a single study or available only as a stand-alone and/or commercial tool. `patRoon 2.0` implements a consistent
interface to the complementary approaches from \autoref{tab:TPApproaches} and other novel functionality to provide
comprehensive TP screening workflows.


Approach           | Principle                            | Requirements                                      | Examples
------------------ | ------------------------------------ | ------------------------------------------------- | -----------------------------------------
TP suspect screening | Screen known/predicted TPs         | Knowledge base/study applicable prediction tools, parent structures  | @DjoumbouFeunang2019, @Wicker2015, @Schymanski2021
Metabolic logic    | Screen molecular mass differences from known transformations | Known (elemental) transformations | @Scholle2015
Mass spectral      | Cluster similar MS data              | Correlation structural and spectral similarity. Availability of fragmentation spectra for respective parents/TPs | @Scholle2017, @Treutler2016, @Naake2017, @Depke2017
Classification     | Parent/TP classification             | In-house statistical/computational expertise      | @Scholle2015, @Brunner2019, @Scholle2021

Table: Implemented TP screening approaches. \label{tab:TPApproaches}

Since wide chemical coverage is desired with NTA and since TPs can ionize differently to their parent, HRMS analyses
are often performed using positive and negative ionization mode. `patRoon 2.0` is now capable of simultaneously
processing, integrating and interpreting mixed mode data - a functionality not available in most workflows due to
complexity and long processing times.

Further improvements to `patRoon` include interactive data curation and new prioritization and identification
strategies, described further below.


# New functionality

## Transformation product screening workflow

The `patRoon 2.0` TP screening workflow starts with features (data points with unique chromatographic/MS information)
obtained from a 'classical' `patRoon` workflow (\autoref{fig:TPworkflow}A). Then, data from one or more of TP screening
(B,C), MS similarity (D) and parent/TP feature classification (E) is combined to link parent and TP features into
components (F). The resulting data is then prioritized (G), corresponding features are annotated (H), and finally all
data is reported (I). All algorithm parameters are configurable, yet simplified via defaults. This enables flexible and
customizable workflows for a wide variety of applications.

TP screening uses known/predicted TP structures from parents (\autoref{fig:TPworkflow}B) or mass differences of
transformations using metabolic logic [@Scholle2015] (C). Parents for (B) are specified from (1) a target list, (2)
results of a _suspect screening_ to find parents by mass, or (3) candidates of feature compound annotation (see
@Helmus2021). Corresponding TP structures are then either obtained _in silico_ with [BioTransformer]
[@DjoumbouFeunang2019], or through a library search from PubChem data [@Kim2021;@Schymanski2021;@Krier2022;@PubChemTPs]
or a custom-made library. Metabolic logic (C), which does not depend on parent structural data, uses transformation
reactions from @Scholle2015 or a custom-made list. TP suspect screening then matches candidate TPs with detected
features by mass.

MS similarity (\autoref{fig:TPworkflow}D) is calculated, without a predefined parent list, from spectral match and/or
equivalence of spectral annotations. Spectral match compares MS fragment spectra (MS/MS) with a cosine or Jaccard index
similarity score [@Stein1994]. This was largely implemented in `C++` to allow efficient comparison of large numbers of
spectra (typically thousands). The calculation can be adjusted by (1) pre-treatment of spectra, e.g. with peak count and
intensity thresholds, (2) weight assignment to intensity and _m/z_ data, and (3) shifting TP spectra to highlight equal
neutral losses [@Watrous2012;@Scholle2017]. Furthermore, combining matched mass peaks from shifted and non-shifted
spectra was implemented for similarity calculation of equivalent fragments _and_ neutral losses. MS similarity from
annotation equivalence compares formulas of annotated MS/MS fragments and neutral losses, based on additional data such
as isotopic fit and spectral libraries. This potentially increases accuracy, but requires presence of annotations for
parent/TP features.

Parent/TP feature classification (\autoref{fig:TPworkflow}E) is typically performed by statistical analyses with `R`,
facilitated by the `patRoon` data export functionality. Fold-change calculation and visualization with volcano plots
[@Cui2003] was implemented in `patRoon 2.0` to simplify the usage of this common classification technique.


![TP screening workflow in `patRoon 2.0`. One or more of steps B/C, D and E are used to generate TP components by
linking and grouping parent/TP features (F). The TP annotation (H) can be enriched with data from (B).
\label{fig:TPworkflow}](TP_workflow.png)


During TP componentization (\autoref{fig:TPworkflow}F), each parent feature is linked with corresponding TP features and
grouped in a TP component. Data prioritization (G) can then be performed with the subsetting functionality of `patRoon`
and several newly implemented filters (\autoref{tab:TPFilters}). Existing [MetFrag] [@Ruttkies2016] annotation
functionality was extended to include predicted TP structures (B) to allow _in silico_ MS/MS annotation (H) of TPs
absent from commonly used databases. The interactive reporting (I) functionality was extended to simplify inspection of
TP screening results (see \autoref{fig:TPreport}).

\newpage

Filter                                      | Remarks
------------------------------------------- | --------------------------------------------------------------------------------------------------
RT direction                                | Verifies expected relative retention time direction of each parent/TP pair based on chemical polarities.
Structure similarity                        | Removes TPs with high MS similarity but low structural similarity.
Explained transformation                    | Verifies the proposed metabolic logic transformation with feature formula annotations.
Remove isomers                              | Removes isomers, which can be difficult or impossible to distinguish with MS.
Duplicates                                  | Removes duplicate TPs formed from the same parent through different pathways.

Table: Filters to prioritize TP components. \label{tab:TPFilters}


![Example report with TP screening results (bottom) for a selected parent (top). \label{fig:TPreport}](report.png){ width=90% }


## Sets workflows: combining positive and negative MS ionization data

In a _sets workflow_, positive and negative data is automatically processed and combined (\autoref{fig:sets_idl}A).
Features are obtained for each polarity, and optionally prioritized with polarity specific conditions (e.g. minimum
intensity). Then, the feature _m/z_ values are replaced with neutral masses calculated from adduct information (defined
manually or via feature adduct annotations), and subsequently aligned and grouped across polarities (with configurable
tolerances). Subsequent steps largely follow the `patRoon 1.0` workflow [@Helmus2021]. Algorithms incapable of
processing polarity mixed data are automatically executed with polarity specific data, and outputs are subsequently
combined. Moreover, a consensus for formula/compound annotations can be reached, for instance, to eliminate candidates
not found for both polarities.

Sets workflows follow a generic design, where each _set_ is a group of analyses that demand independent processing of
MS related data (features, mass spectra etc). Therefore, sets can also be differentiated by other MS parameters such as
MS/MS fragmentation technique or ionization source. Furthermore, the design allows future implementation of workflows
with different chromatographic methods, for instance, to simultaneously process data from different instruments.


![**A**  Sets workflow with simultaneous processing of positive and negative data. Alignment of positive/negative
features can be improved with adduct annotations. The workflow continues identically to the `patRoon 1.0` workflow, and
positive/negative data is automatically processed separately for algorithms without mixed polarity support. **B**
Default `YAML` configuration file used for estimation of suspect identification levels from annotation scores, candidate
rankings and other data. \label{fig:sets_idl}](sets-IDL.png){ width=95% }


## Other new functionality

Other new functionality of `patRoon 2.0` includes:

* Improved suspect screening
    * Automatic estimation of identification levels [@Schymanski2014] using a configurable and extensible rule based approach (see \autoref{fig:sets_idl}B).
    * Combining suspect and non-target screening workflows.
    * Merging results from different screenings.
* Improved adduct annotation
    * Automatic prioritization of features with preferred adducts.
    * Use of adduct annotations with formula/compound annotation.
    * Support for the algorithms of [cliqueMS] [@Senan2019] and [OpenMS] (`MetaboliteAdductDecharger`) [@Rst2016].
* Improved feature data
    * Inclusion of [SIRIUS] [@Dhrkop2019], [SAFD] [@Samanipour2019] and [KPIC2] [@Ji2017] algorithms.
    * Integration of [MetaClean] [@Chetnik2020] for chromatographic peak quality calculation and validation.
    * Calculation and prioritization with peak scores derived from aforementioned peak qualities.
* Interactive graphical tools to inspect and curate workflow data and to train and inspect feature classifications with
`MetaClean`.
* Refactoring and updates of `newProject()` to generate code for the new functionality.
* A `delete` function to remove unwanted workflow data, e.g. to implement custom filters.
* More approaches to parallelize `R` code and support high performance computing using the [future] package
[@Bengtsson2020].
* Bug fixes and improvements from user feedback.

A complete listing of all changes is outlined [the project news file][NEWS].

# Example workflows

## Simultaneous processing of positive/negative data

Performing a sets workflow is straightforward, and requires only few additions to a `patRoon 1.0` workflow.

```r
# Load patRoon and patRoonData libraries.
library(patRoon)
library(patRoonData)

# Obtain features for positive/negative data
fListPos <- findFeatures(exampleAnalysisInfo("positive"), "openms")
fListNeg <- findFeatures(exampleAnalysisInfo("negative"), "openms")

# Initiate sets workflow with default (de-)protonated adducts
fListSet <- makeSet(fListPos, fListNeg, adducts = c("[M+H]+", "[M-H]-"))

# Neutralize features and group across analyses and sets
fGroups <- groupFeatures(fListSet, "openms")

# Perform prioritization, annotation, reporting etc as a 'classical' workflow
...
```

## TP screening

The code below demonstrates a simple TP screening workflow where (1) parents are screened, (2) corresponding TPs are
predicted with `BioTransformer`, (3) the TPs are screened, (4) TP components are generated and (5) all results are
reported.

```r
# (1) Screen parents
parentSuspects <- data.frame(name = c("Carbamazepine", "Benzotriazole"),
                             SMILES = c("C1=CC=C2C(=C1)C=CC3=CC=CC=C3N2C(=O)N",
                                        "C1=CC2=NNN=C2C=C1"))
fGroupsScr <- screenSuspects(fGroups, parentSuspects, adduct = "[M+H]+")

# (2) Predict TPs with BioTransformer
TPs <- generateTPs("biotransformer", parents = fGroupsScr)

# (3) Screen for the TPs and amend previous results
TPSuspects <- convertToSuspects(TPs)
fGroupsScr <- screenSuspects(fGroupsScr, TPSuspects, adduct = "[M+H]+",
                             amend = TRUE)
fGroupsScr <- filter(fGroupsScr, onlyHits = TRUE)

# (4) Generate the TP components
componentsTP <- generateComponents(fGroupsScr, "tp", TPs = TPs)

# (5) Generate interactive HTML report
reportHTML(fGroupsScr, components = componentsTP)
```

The code for these and more advanced workflows are easily generated with the `newProject()` function. The
[Handbook] outlines more examples of typical TP screening workflows.


# Acknowledgements

The authors thank Carl Emil Eskildsen for his suggestions on implementing and evaluating different MS similarity
approaches, Lisa Kooy for her feedback and testing of the TP screening functionality, Pim de Voogt for general
supervision and constructive feedback on the manuscript, as well as María Domínguez Román for her feedback on the
manuscript.

# Funding

R. Helmus was funded by the Institute of Biodiversity and Ecosystem Dynamics (University of Amsterdam) and the
Netherlands Organisation for Scientific Research (NWO) as part of the TooCOLD project carried out within the framework
of TTW Open Technology Programme (project number 15506). A.M. Brunner was funded by the Joint Research Program of the
Dutch and Belgian drinking water companies. E.L. Schymanski was funded by the Luxembourg National Research Fund (FNR)
for project A18/BM/12341006.


# References

[OpenMS]: http://openms.de/
[MetFrag]: http://ipb-halle.github.io/MetFrag/
[SIRIUS]: https://bio.informatik.uni-jena.de/software/sirius/
[cliqueMS]: https://github.com/osenan/cliqueMS
[BioTransformer]: https://bitbucket.org/djoumbou/biotransformer/src/master/
[KPIC2]: https://github.com/hcji/KPIC2
[SAFD]: https://bitbucket.org/SSamanipour/safd.jl/src/master/
[MetaClean]: https://github.com/KelseyChetnik/MetaClean/
[future]: https://github.com/HenrikBengtsson/future
[YAML]: https://yaml.org/
[Handbook]: https://rickhelmus.github.io/patRoon/handbook_bd/index.html
[NEWS]: https://rickhelmus.github.io/patRoon/news/index.html
