
library(patRoon)

# -------------------------
# initialization
# -------------------------

workPath <- "test_temp/test-np/tp-library"
setwd(workPath)

# NOTE: please set to a valid data.frame with analysis information. See ?`analysis-information` for more details.
anaInfo <- data.frame(path_centroid = character(), analysis = character(), replicate = character(), blank = character())

# -------------------------
# features
# -------------------------

# Find all features
# NOTE: see the reference manual for many more options
fList <- findFeatures(anaInfo, "openms", noiseThrInt = 1000, chromSNR = 3, chromFWHM = 5, minFWHM = 1, maxFWHM = 30)

# Group and align features between analyses
fGroups <- groupFeatures(fList, "openms", rtalign = TRUE)

# Basic rule based filtering
fGroups <- filter(fGroups, preAbsMinIntensity = 100, absMinIntensity = 10000, relMinReplicateAbundance = 1,
                  maxReplicateIntRSD = 0.75, blankThreshold = 5, removeBlanks = TRUE, retentionRange = NULL,
                  mzRange = NULL)

# Update group properties
fGroups <- updateGroups(fGroups, what = c("ret", "mz", "mobility"), intWeight = FALSE)

# -------------------------
# transformation products
# -------------------------

# Obtain TPs
TPs <- generateTPs("library", parents = NULL, TPStructParams = getDefTPStructParams())

# Screen TPs
suspListTPs <- convertToSuspects(TPs, includeParents = FALSE)
fGroups <- screenSuspects(fGroups, suspListTPs, rtWindow = 12, mzWindow = 0.005, onlyHits = TRUE)

# -------------------------
# Parent and TP linkage
# -------------------------

# You probably want to prioritize the data before componentization. Please see the handbook for more info.
componentsTP <- generateComponents(fGroups, "tp", fGroupsTPs = fGroups, TPs = TPs)

# You may want to configure the filtering step below. See the manuals for more details.
componentsTP <- filter(componentsTP, retDirMatch = FALSE, minSpecSim = NULL, minSpecSimPrec = NULL,
                       minSpecSimBoth = NULL, minFragMatches = NULL, minNLMatches = NULL, formulas = NULL)

# Only keep linked feature groups
fGroups <- fGroups[results = componentsTP]

# -------------------------
# reporting
# -------------------------

# Advanced report settings can be edited in the report.yml file.
report(fGroups, MSPeakLists = NULL, formulas = NULL, compounds = NULL, components = componentsTP, TPs = TPs,
       settingsFile = "report.yml", openReport = TRUE)
