# Installation

`patRoon` depends on various other software tools to perform the non-target analysis workflow steps and to implement various other functionality. The following installation strategies are discussed here:

1. The `patRoon` bundle, which contains all dependencies (including `R`), and is therefore very easy to setup (Windows only).
2. Reproducible [Docker] images.
3. Regular installations that integrate with the currently installed `R` environment.

The first strategy is recommended if you are using Windows and are new to `R` or quickly want to try out the latest `patRoon` snapshot. Docker images are specifically for users who wish to run isolated containers and ensure high reproducibility. Finally, people already running `R` will most likely prefer the third strategy. Each strategy is discussed separately in the next sections.

## patRoon Bundle

The `patRoon` bundle contains an almost full `patRoon` installation, including `R`, all `R` package dependencies and external software dependencies such as Java JDK, [MetFrag] and various compound libraries etc. Currently, only [ProteoWizard] may need to be installed manually (see X.Y).

The bundles are automatically generated and tested, and can be obtained from [GHRel] for released versions of `patRoon` and [GHPreRel] for the latest snapshot. 

After downloading the bundle, simply extract the `.zip` file. Then, a classic `R` can be launched by executing `R/bin/x64/Rgui.exe` inside the directory where the bundle was extracted. However, it is probably more convenient to use it from [RStudio]: for this start RStudio, navigate to Tools --> Global options --> General tab and manually set the `R` version by selecting `Rterm.exe` from the `R/bin/x64` directory in the bundle (see screenshot below).

### Updating the bundle

To update the bundle run either of the following functions:

```{r eval=FALSE}
patRoonInst::sync(allDeps = TRUE) # synchronize all packages related to patRoon to the currently tested versions
patRoonInst::update() # update all R packages related to patRoon
```

Both functions will update `patRoon` and related packages to their latest versions. However, they differ on handling their dependencies.

In general, it is recommended to synchronize the package dependencies in the bundle, since this ensures that versions were tested with `patRoon`. If you installed any other packages and also want to update these, then _first_ do so with regular mechanisms (e.g. `update.packages()`, `BiocManager::install()`) and _then_ synchronize `patRoon` to ensure that all packages are with tested versions.

However, if you prefer to install the latest version of all dependencies, then running `patRoon::update()` might be more appropriate. In this case, it is still recommended to first update any 'regular' `R` packages as described above, as `patRoonInst::update()` may install some dependencies with a specific version in case other versions are known to not work.

More details on using `patRoonInst` to manage installations are discussed [later].

## Docker image

Docker images are provided to easily install a reproducible environment with `R`, `patRoon` and nearly all of its dependencies. This section assumes you have a basic understanding of [Docker] and have it installed. If not, please refer to the many guides available on the Internet. The Docker images of `patRoon` were originally only used for automated testing, however, since these contain a complete working environment of `patRoon` they are also suitable for using the software. They come with all external dependencies (except ProteoWizard), `R` dependencies and `MetFrag` libraries. Furthermore, the Docker image also contains [RStudio] server, which makes using `patRoon` even easier.

Below are some example shell commands on how to run the image.

```{bash, eval=FALSE}
# run an interactive R console session
docker run --rm -it uva-hva.gitlab.host:4567/r.helmus/patroon/patroonrs

# run a linux shell, from which R can be launched
docker run --rm -it uva-hva.gitlab.host:4567/r.helmus/patroon/patroonrs bash

# run rstudio server, accessible from localhost:8787
# login with rstudio/yourpasswordhere
docker run --rm -p 8787:8787 -u 0 -e PASSWORD=yourpasswordhere uva-hva.gitlab.host:4567/r.helmus/patroon/patroonrs /init

# same as above, but mount a local directory (~/myvolume) as local volume so it can be used for persistent storage
# please ensure that ~/myvolume exists!
docker run --rm -p 8787:8787 -u 0 -e PASSWORD=yourpasswordhere -v ~/myvolume:/home/rstudio/myvolume uva-hva.gitlab.host:4567/r.helmus/patroon/patroonrs /init
```

Note that the first two commands run as the default user `rstudio`, while the last two as `root`. The last commands launch [RStudio] server. You can access it by browsing to `localhost:8787` and logging in with user `rstudio` and the password defined by the `PASSWORD` variable from the command (`yourpasswordhere` in the above example). The last command also links a local volume in order to obtain persistence of files in the container's home directory. The Docker image is based on the excellent work from the [rocker project](https://www.rocker-project.org/). For more information on RStudio related options see their documentation for the [RStudio image].

## Regular R installation

A 'regular' installation involves installing `patRoon` and its dependencies using the local installation of `R`. This section outlines available tools to do this mostly automatically using the auxiliary [patRoonInst] and [patRoonExt] `R` packages and instructions to perform the complete installation manually.

> **_NOTE_**  It is highly recommended to perform installation steps in a 'clean' `R` session to avoid errors when installing or upgrading packages. As such it is recommended to close all open (R Studio) sessions and open a plain R console to perform the installation. 

### Automatic installation

The [patRoonInst] auxiliary package simplifies the installation process. This package automatically installs all `R` package dependencies, including those unavailable from regular repositories such as CRAN and BiocConductor. Furthermore, `patRoonInst` installs [patRoonExt], an `R` package that bundles most common dependencies outside the `R` environment (e.g. [MetFrag], [OpenMS] etc).

The first step is to install `patRoonInst`:

```{r eval=FALSE}
install.packages("patRoonInst", repos = c('https://rickhelmus.r-universe.dev', 'https://cloud.r-project.org'))

# or alternatively, from GitHub
remotes::install_github("rickhelmus/patRoonInst")
```

Then to perform an installation or update:

```{r eval=FALSE}
patRoonInst::install() # install patRoon and any missing dependencies
patRoonInst::update() # update patRoon and its dependencies
```

The installation can be customized in various ways. Firstly, the repositories used to download R packages can be customized through the `origin` argument. The following options are currently available:

* `patRoonDeps`: contains `patRoon` and its dependencies (including their dependencies) with versions that were tested against the latest `patRoon` version. This repository is used for the [patRoon bundle], and only available for on Windows systems.
* r-universe: contains a snapshot of the latest version of `patRoon` and its direct dependencies.
* "regular": in this case packages will be sourced directly from CRAN/BioConductor or GitHub. This means that suitable compilers (e.g. [Rtools]) need to be available during installation.

The default on Windows systems is `patRoonDeps`, and r-universe otherwise.

Other installation customizations include which packages will be installed (or updated), and installing all packages to an isolated `R` library. Some examples:

```{r eval=FALSE}
patRoonInst::install(origin = "runiverse") # install from r-universe
patRoonInst::install(origin = "regular", pkgs = "patRoon") # only install patRoon, without optional dependencies and directly from GitHub
patRoonInst::install(ignorePkgs = c("nontarget", "MetaClean")) # full installation, except these two packages
patRoonInst::install(ignorePkgs = "big") # full installation, but exclude 'big' optional dependencies such as example data (patRoonData)
patRoonInst::install(lib.loc = "~/patRoon-lib") # install everything to an isolated R library (use .libPaths() to use it)
```

Besides installing and updating packages, it is also possible to _synchronize_ them with the selected repository using the `sync()` function. This is mostly the same as `update()`, but can also downgrade packages to ensure their versions exactly match that of the repository. This is primarily useful with the `patRoonDeps` repository (as all package versions are tested). Furthermore, as synchronization may involve downgrading it is primarily intended for environments that are primarily used for `patRoon`, such as the [bundle] and isolated `R` libraries. Synchronization can be performed for direct dependencies or all of them:

```{r eval=FALSE}
patRoonInst::sync() # synchronize only direct dependencies
patRoonInst::sync(allDeps = TRUE) # synchronize all dependencies
```

More options are available to customize the installation, see the reference manual (`?patRoonInst::install`) for more details.

## Manual installation

The manual installation is for users who don't use Windows or Docker, prefer to do a manual installation or simply want to know what happens behind the scenes. The manual installation consists of three phases:

1. Installing some prerequisite `R` packages
2. Install and configure (non-`R`) dependencies
3. Install `patRoon`

### R prerequisites

When installing `patRoon` Windows users have the option to install from a customized ([miniCRAN]) repository (`patRoonDeps`). This repository provides a central repository for `patRoon` and all its R packages. An advantage is that installation will be faster and you will not need to install [Rtools]. Note that you will need to have the latest `R` version installed in order to use this repository.

When you decide to use the `patRoonDeps` repository you can simply _skip_ this step. **Otherwise** (i.e. you will use regular repositories instead), the following will install the `R` dependencies.

```{r eval=FALSE}
install.packages(c("BiocManager", "remotes"))
BiocManager::install("CAMERA")

# needed for finding features with enviPick
remotes::install_github("blosloos/enviPick")

# needed for finding/grouping features with KPIC2
BiocManager::install("ropls")
remotes::install_github("rickhelmus/KPIC2") 

# needed for RAMClustR for componentization
BiocManager::install("InterpretMSSpectrum")
remotes::install_github("cbroeckl/RAMClustR")

# needed for nontarget for componentization
remotes::install_github("blosloos/nontargetData")
remotes::install_github("blosloos/nontarget")

# needed for cliqueMS for componentization
remotes::install_github("rickhelmus/cliqueMS") # note: repository is a fork with minor bug fixes

# only needed for Bruker DataAnalysis integration
# NOTE: a fork is installed that fixes some issues with the latest R versions
remotes::install_github("BSchamberger/RDCOMClient")

# only when using the R interface (not recommended by default)
remotes::install_github("c-ruttkies/MetFragR/metfRag")

# needed for feature quality calculations with MetaClean
BiocManager::install(c("BiocStyle", "Rgraphviz")) 
remotes::install_github("KelseyChetnik/MetaClean")
```

Note that only the `CAMERA` installation is mandatory, the rest involves installation of _optional_ packages. If you are unsure which you need then you can always install the packages at a later stage.

### Other dependencies

Depending on which functionality is used, the following external dependencies may need to be installed:

Dependency                          | Remarks
----------------------------------- | -----------------------------------------------------
[Java JDK][JavaJDK]                 | **Mandatory** for e.g. plotting structures and using MetFrag.
[Rtools]                            | Necessary on Window and when `patRoon` is _not_ installed from `patRoonDeps`.
[ProteoWizard]                      | Needed for automatic data-pretreatment (e.g. data file conversion and centroiding, Bruker users may use DataAnalysis integration instead).
[OpenMS]                            | Recommended. Used for e.g. finding and grouping features.
[MetFrag CL][MetFragCL]             | Recommended. Used for annotation with MetFrag.
[MetFrag CompTox DB][CompTox-dl]    | Database files necessary for usage of the [CompTox] database with MetFrag. Note that a recent version  of MetFrag (>=2.4.5) is required. Note that the lists with additions for [smoking metadata][CompTox-smoke] and [wastewater metadata][CompTox-WW] are also supported.
[MetFrag PubChemLite DB][PCLite-dl] | Database file needed to use [PubChemLite][PCLite-paper] with MetFrag.
[MetFrag PubChem OECD PFAS DB][PC-PFAS] | Database file to use the OECD PFAS database with MetFrag.
[SIRIUS]                            | For obtaining feature data and formula and/or compound annotation.
[BioTransformer]                    | For prediction of transformation products. See the [BioTransformer] page for installation details. If you have trouble compiling the jar file you can download it from [here](https://github.com/rickhelmus/patRoonDeps/raw/master/ext/biotransformer-3.0.0.jar).
[SAFD]                              | For finding features with [SAFD]. Please follow all the installation on the [SAFD webpage][SAFD].
[OpenBabel]                         | Used by e.g. suspect screening to automatically validate and calculate chemical properties such as InChI and formulae. While optional, highly recommended.
[pngquant]                          | Used to reduce size of HTML reports (only legacy interface), definitely optional.

Most of these dependencies are optional and only needed if their algorithms are used during the workflow. If you are unsure which are needed, simply skip them for now and install them at a later stage if needed.

After installation of these dependencies you may need to configure their filepaths (OpenMS and ProteoWizard are usually found automatically). To configure the file locations you should set some global package options with the `options()` R function, for instance:

```{r, eval=FALSE}
options(patRoon.path.pwiz = "C:/ProteoWizard") # location of ProteoWizard installation folder
options(patRoon.path.SIRIUS = "C:/sirius-win64-3.5.1") # location where SIRIUS was extracted
options(patRoon.path.OpenMS = "/usr/local/bin") # directory with the OpenMS binaries
options(patRoon.path.pngquant = "~/pngquant") # directory containing pngquant binary
options(patRoon.path.MetFragCL = "~/MetFragCommandLine-2.4.8.jar") # full location to the jar file
options(patRoon.path.MetFragCompTox = "C:/CompTox_17March2019_SelectMetaData.csv") # full location to desired CompTox CSV file
options(patRoon.path.MetFragPubChemLite = "~/PubChemLite_exposomics_20220429.csv") # full location to desired PubChemLite CSV file
options(patRoon.path.MetFragPubChemLite = "~/PubChem_OECDPFAS_largerPFASparts_20220324") # full location to PFAS DB (NOTE: configured like PubChemLite)
options(patRoon.path.BioTransformer = "~/biotransformer/biotransformer-3.0.1.jar")
options(patRoon.path.obabel = "C:/Program Files/OpenBabel-3.0.0") # directory with OpenBabel binaries
```

These commands have to be executed everytime you start a new R session (e.g. as part of your script). However, it is probably easier to add them to your `~/.Rprofile` file so that they are executed automatically when you start R. If you don't have this file yet you can simply create it yourself (for more information see e.g. [this SO answer](https://stackoverflow.com/a/46819910)).

### patRoon installation

Finally, it is time to install `patRoon` itself. As mentioned before, Windows users (who have the latest `R` version) can install `patRoon` and all its package dependencies from the `patRoonDeps` repository:

```{r eval=FALSE}
# install from patRoonDeps (only Windows with latest R version)
install.packages("patRoon", repos = "https://rickhelmus.github.io/patRoonDeps/", type = "binary")
```

**Otherwise**, installation occurs directly from GitHub:

```{r eval=FALSE}
remotes::install_github("rickhelmus/patRoon")
```

Optional example data is installed via GitHub:

```{r eval=FALSE}
# optional example data
remotes::install_github("rickhelmus/patRoonData")
```


Afterwards, you can run the `verifyDependencies()` function to see if `patRoon` can find all its dependencies (you may need to restart R beforehand):

```{r eval=FALSE}
patRoon::verifyDependencies()
```

```{r child=file.path(vignDir, "shared", "_refs.Rmd")}
```
